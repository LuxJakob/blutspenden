name: Run Data Transformation

on:
  workflow_dispatch:

jobs:
  transform:
    name: Extract and Convert Health Data
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install --upgrade pip

      - name: Run data transformation
        run: python transform_data.py

      - name: Trigger health_records workflow
        env:
          ACTION_TOKEN: ${{ secrets.ACTION_TOKEN }}
        run: |
          REPO_OWNER="LuxJakob"
          REPO_NAME="blutspenden"
          ACTION_NAME="health_records.yaml"
          curl -L \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $ACTION_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/actions/workflows/$ACTION_NAME/dispatches \
            -d '{"ref":"main"}'
